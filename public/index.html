<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home - Quiz Grid</title>
    <link rel="icon" type="image/png" href="/transparent logo.png">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <div id="navbar-container"></div>

    <div class="container">
        <h2 style="margin-bottom: 20px; text-align: center;">Welcome to Quiz Grid</h2>
        <p style="text-align: center; margin-bottom: 30px; color: var(--text-secondary, #d0d0d0);">
            Customize your quiz experience!
        </p>
        
        <div class="quiz-config-form">
            <form id="quizConfigForm">
                <div class="form-group">
                    <label for="questionCount">Number of questions (1-10)</label>
                    <input type="number" id="questionCount" name="questionCount" min="1" max="10" value="10" required>
                </div>

                <div class="form-group">
                    <label for="category">Category</label>
                    <select id="category" name="category">
                        <option value="">Any Category</option>
                        <option value="9">General Knowledge</option>
                        <option value="10">Entertainment: Books</option>
                        <option value="11">Entertainment: Film</option>
                        <option value="12">Entertainment: Music</option>
                        <option value="13">Entertainment: Musicals & Theatres</option>
                        <option value="14">Entertainment: Television</option>
                        <option value="15">Entertainment: Video Games</option>
                        <option value="16">Entertainment: Board Games</option>
                        <option value="17">Science & Nature</option>
                        <option value="18">Science: Computers</option>
                        <option value="19">Science: Mathematics</option>
                        <option value="20">Mythology</option>
                        <option value="21">Sports</option>
                        <option value="22">Geography</option>
                        <option value="23">History</option>
                        <option value="24">Politics</option>
                        <option value="25">Art</option>
                        <option value="26">Celebrities</option>
                        <option value="27">Animals</option>
                        <option value="28">Vehicles</option>
                        <option value="29">Entertainment: Comics</option>
                        <option value="30">Science: Gadgets</option>
                        <option value="31">Entertainment: Japanese Anime & Manga</option>
                        <option value="32">Entertainment: Cartoon & Animations</option>
                    </select>
                </div>

                <button type="submit" id="startQuizBtn" class="btn">Start Quiz</button>
            </form>
        </div>
    </div>

    <script src="/js/navbar.js"></script>
    <script>
        // Check authentication with retry logic to handle cookie timing issues
        // This is especially important in serverless environments where cookies may take time to be available
        (async function checkAuthOnLoad() {
            const maxRetries = 3;
            const retryDelay = 300; // 300ms between retries
            
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    // Add delay on retries to give cookie time to be available
                    if (attempt > 0) {
                        await new Promise(resolve => setTimeout(resolve, retryDelay));
                    }
                    
                    const response = await fetch('/api/auth/status', {
                        credentials: 'include',
                        cache: 'no-store' // Prevent caching of auth status
                    });
                    
                    if (response.status === 401) {
                        // If this is the last attempt, redirect to login
                        if (attempt === maxRetries - 1) {
                            window.location.href = '/login.html';
                            return;
                        }
                        // Otherwise, retry
                        continue;
                    }
                    
                    const data = await response.json();
                    
                    if (data.success && data.authenticated) {
                        // Authentication successful, stop checking
                        return;
                    }
                    
                    // If this is the last attempt, redirect to login
                    if (attempt === maxRetries - 1) {
                        window.location.href = '/login.html';
                        return;
                    }
                } catch (error) {
                    console.error(`Auth check error (attempt ${attempt + 1}):`, error);
                    // If this is the last attempt, redirect to login
                    if (attempt === maxRetries - 1) {
                        window.location.href = '/login.html';
                        return;
                    }
                }
            }
        })();

        document.addEventListener('DOMContentLoaded', async function() {
            const quizConfigForm = document.getElementById('quizConfigForm');
            const questionCountInput = document.getElementById('questionCount');
            const startQuizBtn = document.getElementById('startQuizBtn');

            // Validate question count and enable/disable button
            function validateQuestionCount() {
                const value = parseInt(questionCountInput.value);
                const isValid = !isNaN(value) && value >= 1 && value <= 10;
                startQuizBtn.disabled = !isValid;
                
                if (!isValid && questionCountInput.value !== '') {
                    questionCountInput.setCustomValidity('Please enter a number between 1 and 10');
                } else {
                    questionCountInput.setCustomValidity('');
                }
            }

            // Validate on input change
            questionCountInput.addEventListener('input', validateQuestionCount);
            questionCountInput.addEventListener('change', validateQuestionCount);
            questionCountInput.addEventListener('blur', validateQuestionCount);
            
            // Initial validation (should enable button since default is 10)
            validateQuestionCount();

            // Handle form submission
            quizConfigForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                // Disable button to prevent multiple clicks
                startQuizBtn.disabled = true;
                startQuizBtn.textContent = 'Starting...';
                
                try {
                    // Check authentication before navigating
                    const authResponse = await fetch('/api/auth/status', {
                        credentials: 'include'
                    });
                    
                    if (authResponse.status === 401) {
                        // Not authenticated - redirect to login immediately
                        window.location.href = '/login.html';
                        return;
                    }
                    
                    const authData = await authResponse.json();
                    
                    if (!authData.success || !authData.authenticated) {
                        // Not authenticated - redirect to login
                        window.location.href = '/login.html';
                        return;
                    }

                    // Get form values
                    const questionCount = document.getElementById('questionCount').value;
                    const category = document.getElementById('category').value;

                    // Validate question count before proceeding
                    const count = parseInt(questionCount);
                    if (isNaN(count) || count < 1 || count > 10) {
                        alert('Please enter a number of questions between 1 and 10.');
                        startQuizBtn.disabled = false;
                        startQuizBtn.textContent = 'Start Quiz';
                        return;
                    }

                    // Store quiz configuration in sessionStorage
                    const quizConfig = {
                        amount: count,
                        category: category || ''
                    };
                    
                    console.log('Storing quiz config:', quizConfig);
                    sessionStorage.setItem('quizConfig', JSON.stringify(quizConfig));
                    
                    // Verify it was stored
                    const verifyConfig = sessionStorage.getItem('quizConfig');
                    console.log('Verified stored config:', verifyConfig);
                    
                    // Build URL with query parameters as backup
                    const params = new URLSearchParams();
                    params.set('amount', count.toString());
                    if (category && category !== '') {
                        params.set('category', category);
                    }
                    
                    // Navigate to quiz page with query parameters
                    window.location.href = '/quiz.html?' + params.toString();
                } catch (error) {
                    console.error('Error starting quiz:', error);
                    alert('Failed to start quiz. Please try again.');
                    startQuizBtn.disabled = false;
                    startQuizBtn.textContent = 'Start Quiz';
                }
            });
        });
    </script>
</body>
</html>
